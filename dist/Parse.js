"use strict";var Grammar=require("./Grammar"),_require=require("./Message"),IncomingRequest=_require.IncomingRequest,IncomingResponse=_require.IncomingResponse;function parse(e){var r,a,s=e.indexOf("\r\n");if(-1===s)return null;var t=e.substring(0,s),n=Grammar.parse(t,"Request_Response");if(-1!==n){n.status_code?((r=new IncomingResponse).status_code=n.status_code,r.reason_phrase=n.reason_phrase):((r=new IncomingRequest).method=n.method,r.ruri=n.uri),r.data=e;for(var o=s+2;;){if(-2===(s=getHeader(e,o))){a=o+2;break}if(-1===s)return void console.error("parseMessage() | malformed message");if(!0!==(n=parseHeader(r,e,o,s)))return void console.error("parseMessage() |",n.error);o=s+2}if(r.hasHeader("content-length")){var c=r.getHeader("content-length");if(r.body=e.substr(a,c),r.hasHeader("content-type"))"application/sdp"===r.getHeader("content-type")&&c&&r.parseSDP()}else r.body=e.substring(a);return r}console.error('parseMessage() | error parsing first line of SIP message: "'.concat(t,'"'))}function getHeader(e,r){var a=r,s=0,t=0;if(e.substring(a,a+2).match(/(^\r\n)/))return-2;for(;0===s;){if(-1===(t=e.indexOf("\r\n",a)))return t;!e.substring(t+2,t+4).match(/(^\r\n)/)&&e.charAt(t+2).match(/(^\s+)/)?a=t+2:s=t}return s}function parseHeader(e,r,a,s){var t,n=r.indexOf(":",a),o=r.substring(a,n).trim(),c=r.substring(n+1,s).trim();switch(o.toLowerCase()){case"via":case"v":e.addHeader("via",c),1===e.getHeaders("via").length?(t=e.parseHeader("Via"))&&(e.via=t,e.via_branch=t.branch):t=0;break;case"from":case"f":e.setHeader("from",c),(t=e.parseHeader("from"))&&(e.from=t,e.from_tag=t.getParam("tag"));break;case"to":case"t":e.setHeader("to",c),(t=e.parseHeader("to"))&&(e.to=t,e.to_tag=t.getParam("tag"));break;case"record-route":if(-1===(t=Grammar.parse(c,"Record_Route")))t=void 0;else{var i=!0,d=!1,p=void 0;try{for(var u,f=t[Symbol.iterator]();!(i=(u=f.next()).done);i=!0){var l=u.value;e.addHeader("record-route",c.substring(l.possition,l.offset)),e.headers["Record-Route"][e.getHeaders("record-route").length-1].parsed=l.parsed}}catch(e){d=!0,p=e}finally{try{i||null==f.return||f.return()}finally{if(d)throw p}}}break;case"call-id":case"i":e.setHeader("call-id",c),(t=e.parseHeader("call-id"))&&(e.call_id=c);break;case"contact":case"m":if(-1===(t=Grammar.parse(c,"Contact")))t=void 0;else{var g=!0,m=!1,H=void 0;try{for(var h,v=t[Symbol.iterator]();!(g=(h=v.next()).done);g=!0){var b=h.value;e.addHeader("contact",c.substring(b.possition,b.offset)),e.headers.Contact[e.getHeaders("contact").length-1].parsed=b.parsed}}catch(e){m=!0,H=e}finally{try{g||null==v.return||v.return()}finally{if(m)throw H}}}break;case"content-length":case"l":e.setHeader("content-length",c),t=e.parseHeader("content-length");break;case"content-type":case"c":e.setHeader("content-type",c),t=e.parseHeader("content-type");break;case"cseq":e.setHeader("cseq",c),(t=e.parseHeader("cseq"))&&(e.cseq=t.value),e instanceof IncomingResponse&&(e.method=t.method);break;case"max-forwards":e.setHeader("max-forwards",c),t=e.parseHeader("max-forwards");break;case"www-authenticate":e.setHeader("www-authenticate",c),t=e.parseHeader("www-authenticate");break;case"proxy-authenticate":e.setHeader("proxy-authenticate",c),t=e.parseHeader("proxy-authenticate");break;case"session-expires":case"x":e.setHeader("session-expires",c),(t=e.parseHeader("session-expires"))&&(e.session_expires=t.expires,e.session_expires_refresher=t.refresher);break;case"refer-to":case"r":e.setHeader("refer-to",c),(t=e.parseHeader("refer-to"))&&(e.refer_to=t);break;case"replaces":e.setHeader("replaces",c),(t=e.parseHeader("replaces"))&&(e.replaces=t);break;case"event":case"o":e.setHeader("event",c),(t=e.parseHeader("event"))&&(e.event=t);break;default:e.addHeader(o,c),t=0}return void 0!==t||{error:'error parsing header "'.concat(o,'"')}}module.exports={parse:parse};