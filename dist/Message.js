"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}var Utils=require("./Utils"),Grammar=require("./Grammar"),sdp_transform=require("sdp-transform"),Constants=require("./Constants"),IncomingMessage=function(){function t(){_classCallCheck(this,t),this.data=null,this.headers=null,this.method=null,this.via=null,this.via_branch=null,this.call_id=null,this.cseq=null,this.from=null,this.from_tag=null,this.to=null,this.to_tag=null,this.body=null,this.sdp=null}return _createClass(t,[{key:"addHeader",value:function(t,e){var r={raw:e};t=Utils.headerize(t),this.headers[t]?this.headers[t].push(r):this.headers[t]=[r]}},{key:"getHeader",value:function(t){var e=this.headers[Utils.headerize(t)];if(e)return e[0]?e[0].raw:void 0}},{key:"getHeaders",value:function(t){var e=this.headers[Utils.headerize(t)],r=[];if(!e)return[];var n=!0,o=!1,a=void 0;try{for(var s,i=e[Symbol.iterator]();!(n=(s=i.next()).done);n=!0){var c=s.value;r.push(c.raw)}}catch(t){o=!0,a=t}finally{try{n||null==i.return||i.return()}finally{if(o)throw a}}return r}},{key:"hasHeader",value:function(t){return!!this.headers[Utils.headerize(t)]}},{key:"parseHeader",value:function(t,e){var r=1<arguments.length&&void 0!==e?e:0;if(t=Utils.headerize(t),this.headers[t]){if(!(r>=this.headers[t].length)){var n=this.headers[t][r],o=n.raw;if(n.parsed)return n.parsed;var a=Grammar.parse(o,t.replace(/-/g,"_"));return-1===a?(this.headers[t].splice(r,1),void console.log('error parsing "'.concat(t,'" header field with value "').concat(o,'"'))):n.parsed=a}console.log('not so many "'.concat(t,'" headers present'))}else console.log('header "'.concat(t,'" not present'))}},{key:"s",value:function(t,e){return this.parseHeader(t,e)}},{key:"setHeader",value:function(t,e){var r={raw:e};this.headers[Utils.headerize(t)]=[r]}},{key:"parseSDP",value:function(t){return!t&&this.sdp||(this.sdp=sdp_transform.parse(this.body||"")),this.sdp}},{key:"toString",value:function(){return this.data}}]),t}(),IncomingRequest=function(){function r(t){var e;return _classCallCheck(this,r),(e=_possibleConstructorReturn(this,_getPrototypeOf(r).call(this))).ua=t,e.headers={},e.ruri=null,e.transport=null,e.server_transaction=null,e}return _inherits(r,IncomingMessage),_createClass(r,[{key:"reply",value:function(t,e,r,n,o,a){var s=[],i=this.getHeader("To");if(e=e||null,!(t=t||null)||t<100||699<t)throw new TypeError("Invalid status_code: ".concat(t));if(e&&"string"!=typeof e&&!(e instanceof String))throw new TypeError("Invalid reason_phrase: ".concat(e));e=e||Constants.REASON_PHRASE[t]||"",r=Utils.cloneArray(r);var c="SIP/2.0 ".concat(t," ").concat(e,"\r\n");if(this.method===Constants.INVITE&&100<t&&t<=200){var l=this.getHeaders("record-route"),u=!0,h=!1,f=void 0;try{for(var p,d=l[Symbol.iterator]();!(u=(p=d.next()).done);u=!0){var y=p.value;c+="Record-Route: ".concat(y,"\r\n")}}catch(t){h=!0,f=t}finally{try{u||null==d.return||d.return()}finally{if(h)throw f}}}var _=this.getHeaders("via"),v=!0,g=!1,m=void 0;try{for(var C,b=_[Symbol.iterator]();!(v=(C=b.next()).done);v=!0){var w=C.value;c+="Via: ".concat(w,"\r\n")}}catch(t){g=!0,m=t}finally{try{v||null==b.return||b.return()}finally{if(g)throw m}}!this.to_tag&&100<t?i+=";tag=".concat(Utils.newTag()):this.to_tag&&!this.s("to").hasParam("tag")&&(i+=";tag=".concat(this.to_tag)),c+="To: ".concat(i,"\r\n"),c+="From: ".concat(this.getHeader("From"),"\r\n"),c+="Call-ID: ".concat(this.call_id,"\r\n"),c+="CSeq: ".concat(this.cseq," ").concat(this.method,"\r\n");var S=!0,P=!1,O=void 0;try{for(var T,E=r[Symbol.iterator]();!(S=(T=E.next()).done);S=!0){var I=T.value;c+="".concat(I.trim(),"\r\n")}}catch(t){P=!0,O=t}finally{try{S||null==E.return||E.return()}finally{if(P)throw O}}switch(this.method){case Constants.INVITE:this.ua.configuration.session_timers&&s.push("timer"),(this.ua.contact.pub_gruu||this.ua.contact.temp_gruu)&&s.push("gruu"),s.push("ice","replaces");break;case Constants.UPDATE:this.ua.configuration.session_timers&&s.push("timer"),n&&s.push("ice"),s.push("replaces")}if(s.push("outbound"),this.method===Constants.OPTIONS?(c+="Allow: ".concat(Constants.ALLOWED_METHODS,"\r\n"),c+="Accept: ".concat(Constants.ACCEPTED_BODY_TYPES,"\r\n")):405===t?c+="Allow: ".concat(Constants.ALLOWED_METHODS,"\r\n"):415===t&&(c+="Accept: ".concat(Constants.ACCEPTED_BODY_TYPES,"\r\n")),c+="Supported: ".concat(s,"\r\n"),n){var H=Utils.str_utf8_length(n);c+="Content-Type: application/sdp\r\n",c+="Content-Length: ".concat(H,"\r\n\r\n"),c+=n}else c+="Content-Length: ".concat(0,"\r\n\r\n");this.server_transaction.receiveResponse(t,c,o,a)}},{key:"reply_sl",value:function(t,e){var r=0<arguments.length&&void 0!==t?t:null,n=1<arguments.length&&void 0!==e?e:null,o=this.getHeaders("via");if(!r||r<100||699<r)throw new TypeError("Invalid status_code: ".concat(r));if(n&&"string"!=typeof n&&!(n instanceof String))throw new TypeError("Invalid reason_phrase: ".concat(n));n=n||Constants.REASON_PHRASE[r]||"";var a="SIP/2.0 ".concat(r," ").concat(n,"\r\n"),s=!0,i=!1,c=void 0;try{for(var l,u=o[Symbol.iterator]();!(s=(l=u.next()).done);s=!0){var h=l.value;a+="Via: ".concat(h,"\r\n")}}catch(t){i=!0,c=t}finally{try{s||null==u.return||u.return()}finally{if(i)throw c}}var f=this.getHeader("To");!this.to_tag&&100<r?f+=";tag=".concat(Utils.newTag()):this.to_tag&&!this.s("to").hasParam("tag")&&(f+=";tag=".concat(this.to_tag)),a+="To: ".concat(f,"\r\n"),a+="From: ".concat(this.getHeader("From"),"\r\n"),a+="Call-ID: ".concat(this.call_id,"\r\n"),a+="CSeq: ".concat(this.cseq," ").concat(this.method,"\r\n"),a+="Content-Length: ".concat(0,"\r\n\r\n"),this.transport.send(a)}}]),r}(),IncomingResponse=function(){function e(){var t;return _classCallCheck(this,e),(t=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))).headers={},t.status_code=null,t.reason_phrase=null,t}return _inherits(e,IncomingMessage),e}();module.exports={IncomingRequest:IncomingRequest,IncomingResponse:IncomingResponse};